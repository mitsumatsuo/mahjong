import type { NextPage } from "next";
import Head from "next/head";
import { useCallback, useState } from "react";

type User = {
  id: number;
  name: string;
  checked: boolean;
};

type Match = {
  id: number;
  name: string;
  users: string[];
};

const removeDup = (value: Match[]): Match[] => {
  let ret: Match[] = [];

  value.forEach((i) => {
    let f = ret.find((r) => r.id === i.id);
    if (!f) {
      ret.push(i);
    }
  });

  ret.sort((a, b) => (a.id < b.id ? -1 : 1));

  return ret;
};

const countAvailableMemberCount = (
  users: User[],
  targetMembers: string[]
): number => {
  let n = 0;
  targetMembers.forEach((mem) => {
    const found = users.find((user) => user.name === mem);
    if (found && found.checked) {
      n++;
    }
  });
  return n;
};

const defaultUsers: User[] = [
  { id: 0, name: "æ©‹æœ¬", checked: false },
  { id: 1, name: "è—¤ç”°", checked: false },
  { id: 2, name: "æ¸¡è¾º", checked: false },
  { id: 3, name: "æ¾å°¾", checked: false },
  { id: 4, name: "ä¸­å·", checked: false },
  { id: 5, name: "å°æ—", checked: false },
  { id: 6, name: "æ—", checked: false },
  { id: 7, name: "ä¸­å±±", checked: false },
  { id: 8, name: "é«˜é ˆè³€", checked: false },
  { id: 9, name: "å®®åœ°", checked: false },
];

const matches = [
  { id: 0, name: "ğŸ€™", users: ["æ©‹æœ¬", "è—¤ç”°", "æ¾å°¾", "æ—"] },
  { id: 1, name: "ğŸ€š", users: ["è—¤ç”°", "æ¸¡è¾º", "ä¸­å·", "ä¸­å±±"] },
  { id: 2, name: "ğŸ€›", users: ["æ¸¡è¾º", "æ¾å°¾", "å°æ—", "é«˜é ˆè³€"] },
  { id: 3, name: "ğŸ€œ", users: ["æ¾å°¾", "ä¸­å·", "æ—", "å®®åœ°"] },
  { id: 4, name: "ğŸ€", users: ["ä¸­å·", "å°æ—", "ä¸­å±±", "æ©‹æœ¬"] },
  { id: 5, name: "ğŸ€", users: ["å°æ—", "æ—", "é«˜é ˆè³€", "è—¤ç”°"] },
  { id: 6, name: "ğŸ€Ÿ", users: ["æ—", "ä¸­å±±", "å®®åœ°", "æ¸¡è¾º"] },
  { id: 7, name: "ğŸ€ ", users: ["ä¸­å±±", "é«˜é ˆè³€", "æ©‹æœ¬", "æ¾å°¾"] },
  { id: 8, name: "ğŸ€¡", users: ["é«˜é ˆè³€", "å®®åœ°", "è—¤ç”°", "ä¸­å·"] },
  { id: 9, name: "ğŸ€ƒ", users: ["å®®åœ°", "æ©‹æœ¬", "æ¸¡è¾º", "å°æ—"] },
];

const title = "ç«¶æŠ€ã¾ãã˜ã‚ƒã‚“éƒ¨";

const Home: NextPage = () => {
  const [users, setUsers] = useState(defaultUsers);
  const [filteredMatches, setFilteredMatches] = useState(matches);

  const clickClearEventHandler = useCallback(() => {
    setUsers((s) => {
      return s.map((ss) => {
        return {
          ...ss,
          checked: false,
        };
      });
    });
  }, []);

  const clickEventHandler = useCallback((e: User) => {
    e.checked = !e.checked;
    setUsers((old) => [
      ...old.filter((user) => user.id < e.id),
      e,
      ...old.filter((user) => user.id > e.id),
    ]);
  }, []);

  // useEffect(() => {
  //   let availableMatches: Match[] = [];
  //   users.forEach((user) => {
  //     if (user.checked) {
  //       const newValue = matches.filter((m) => m.users.includes(user.name));
  //       availableMatches.push(...newValue);
  //     }
  //   });

  //   setFilteredMatches(removeDup(availableMatches.length === 0 ? matches : availableMatches));
  // }, [users, setFilteredMatches]);

  return (
    <div className="bg-gradient-to-br from-green-800/90 via-green-800/90 to-green-800/90 select-none min-h-screen">
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className="">
        <h1 className="font-bold text-2xl bg-gradient-to-r from-rose-500 via-rose-400 to-rose-300 text-white p-1">
          {title}ğŸ€‡ğŸ€‡ğŸ€‡ğŸ€ˆğŸ€‰ğŸ€ŠğŸ€‹ğŸ€‹ğŸ€ŒğŸ€ğŸ€ğŸ€ğŸ€ğŸ€
        </h1>
        <div className="p-2">
          <div className="">
            <span className="font-bold text-white text-base">ãƒ¡ãƒ³ãƒãƒ¼</span>
          </div>
          <div className="flex space-x-1 sm:space-x-2 md:space-x-3 2xl:space-x-4 items-center font-serif">
            {users.map((user) => {
              return user.checked ? (
                <div
                  key={user.id}
                  className="bg-white font-bold text-[red] text-center px-2 2xl:px-4 rounded-md border-2 border-black cursor-pointer shadow shadow-blue-500 w-10 h-16 2xl:w-16 2xl:h-20 flex justify-center items-center text-xl 2xl:text-2xl"
                  onClick={() => clickEventHandler(user)}
                >
                  {user.name}
                </div>
              ) : (
                <div
                  key={user.id}
                  className="bg-blue-500 text-blue-50 text-center px-2 2xl:px-4 rounded-md border-2 border-black cursor-pointer shadow shadow-blue-500 w-10 h-16 2xl:w-16 2xl:h-20 flex justify-center items-center text-xl 2xl:text-2xl"
                  onClick={() => clickEventHandler(user)}
                >
                  {user.name}
                </div>
              );
            })}
            {users.some((user) => user.checked) ? (
              <div
                className="bg-yellow-500 text-yellow-50 text-center whitespace-nowrap px-4 rounded border border-yellow-500 select-none cursor-pointer shadow shadow-yellow-500 uppercase"
                onClick={() => clickClearEventHandler()}
              >
                æµå±€
              </div>
            ) : (
              <></>
            )}
          </div>
          <hr className="my-3" />
          <div className="font-bold text-white text-base">ãƒãƒƒãƒãƒ³ã‚°çŠ¶æ³</div>
          <div className="w-full grid grid-cols-2 sm:grid-cols-3 xl:grid-cols-4 grid-flow-row gap-1 md:gap-1 lg:gap-2 2xl:gap-4">
            {filteredMatches.map((match) => {
              const numOfAvailable = countAvailableMemberCount(
                users,
                match.users
              );
              return (
                <div
                  key={match.id}
                  className="w-[180px] 2xl:w-[300px] h-[180px] 2xl:h-[300px] 2xl:m-8 2xl:p-8 rounded-lg border-2 2xl:border-8 border-green-900 bg-[green]"
                >
                  <div className="flex justify-between items-center m-1 2xl:m-4 font-serif">
                    <span className="text-3xl 2xl:text-5xl">{match.name}</span>
                    {numOfAvailable === 4 ? (
                      <span className="text-lg 2xl:text-2xl px-2 2xl:px-4 py-px 2xl:py-1 rounded-md bg-[blue] text-white 2xl:shadow-sm shadow-[blue]/80">
                        è´ç‰Œ
                      </span>
                    ) : numOfAvailable === 3 ? (
                      <span className="text-lg 2xl:text-2xl px-2 2xl:px-4 py-px 2xl:py-1 rounded-md bg-[orange] text-white 2xl:shadow-sm shadow-[orange]/80">
                        ä¸€å‘è´
                      </span>
                    ) : numOfAvailable === 2 ? (
                      <span className="text-lg 2xl:text-2xl px-2 2xl:px-4 py-px 2xl:py-1 rounded-md bg-rose-500 text-white 2xl:shadow-sm shadow-rose-500/80">
                        äºŒå‘è´
                      </span>
                    ) : numOfAvailable === 1 ? (
                      <span className="text-lg 2xl:text-2xl px-2 2xl:px-4 py-px 2xl:py-1 rounded-md bg-[brown] text-white 2xl:shadow-sm shadow-[brown]/80">
                        ä¸‰å‘è´
                      </span>
                    ) : (
                      <span className="text-lg 2xl:text-2xl px-2 2xl:px-4 py-px 2xl:py-1 rounded-md bg-[purple] text-white 2xl:shadow-sm shadow-[purple]/80">
                        å››å‘è´
                      </span>
                    )}
                  </div>
                  <div className="mt-4 2xl:mt-10 flex justify-between text-center m-2 2xl:m-4 items-center font-serif 2xl:gap-4 tracking-wide">
                    {match.users.map((un) => {
                      let y = users.filter(
                        (user) => user.checked && user.name === un
                      );
                      return y && y.length > 0 ? (
                        <div className="text-2xl 2xl:text-4xl w-16 h-20 text-[orange]">
                          {un}
                        </div>
                      ) : (
                        <div className="text-2xl 2xl:text-4xl w-16 h-20 text-slate-400">
                          {un}
                        </div>
                      );
                    })}
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      </main>
    </div>
  );
};

export default Home;
